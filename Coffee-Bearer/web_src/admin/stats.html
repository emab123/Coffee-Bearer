<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estat√≠sticas - Cafeteira RFID</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="app-title">
                <div class="coffee-icon">‚òï</div>
                <div>
                    <h1>Cafeteira RFID - Admin</h1>
                    <p class="version">Estat√≠sticas do Sistema v4.0</p>
                </div>
            </div>
            <div class="user-info">
                <div class="user-avatar">A</div>
                <div>
                    <div class="user-name">Administrador</div>
                    <div class="user-role">Admin</div>
                </div>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>
        </header>

        <nav class="app-nav">
            <ul class="nav-tabs">
                <li class="nav-tab"><a href="/admin/dashboard">Dashboard</a></li>
                <li class="nav-tab"><a href="/admin/users">Usu√°rios</a></li>
                <li class="nav-tab"><a href="/admin/settings">Configura√ß√µes</a></li>
                <li class="nav-tab"><a href="/admin/logs">Logs</a></li>
                <li class="nav-tab active"><a href="/admin/stats">Estat√≠sticas</a></li>
            </ul>
        </nav>

        <main class="app-main">
            <div id="alertContainer"></div>

            <section class="page-controls">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìä Controles de Estat√≠sticas</h3>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="refreshStats()">
                            üîÑ Atualizar Dados
                        </button>
                        <select id="timeRangeFilter" class="form-select" onchange="refreshStats()">
                            <option value="7d">√öltimos 7 dias</option>
                            <option value="30d">√öltimos 30 dias</option>
                            <option value="all">Todo o per√≠odo</option>
                        </select>
                    </div>
                </div>
            </section>

            <section class="stats-kpis">
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number" id="kpiTotalServed">0</span>
                        <span class="stat-label">Total de Caf√©s Servidos</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="kpiDailyAverage">0</span>
                        <span class="stat-label">M√©dia Di√°ria</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="kpiPeakDay">N/A</span>
                        <span class="stat-label">Dia de Pico</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="kpiTopUser">N/A</span>
                        <span class="stat-label">Usu√°rio Mais Ativo</span>
                    </div>
                </div>
            </section>

            <section class="charts-section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Consumo de Caf√© ao Longo do Tempo</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="consumptionChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Distribui√ß√£o de Status dos Usu√°rios</h3>
                    </div>
                    <div class="chart-container" style="max-width: 400px; margin: auto;">
                        <canvas id="usersChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Hor√°rios de Pico de Consumo</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>
            </section>

             <section class="top-users-section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Top 5 Usu√°rios (por consumo)</h3>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Posi√ß√£o</th>
                                    <th>Nome</th>
                                    <th>UID</th>
                                    <th>Caf√©s Consumidos</th>
                                </tr>
                            </thead>
                            <tbody id="topUsersTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text">Carregando estat√≠sticas...</div>
    </div>

    <script src="/js/app.js"></script>
    <script src="/js/admin.js"></script>

    <script>
        // Vari√°veis para as inst√¢ncias dos gr√°ficos
        let consumptionChart, usersChart, hourlyChart;

        // Inicializa√ß√£o da p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            initStatsPage();
        });

        function initStatsPage() {
            checkAuth(); // Verifica se o usu√°rio est√° logado
            initCharts(); // Prepara os canvases dos gr√°ficos
            
            // Solicita os dados ao backend via WebSocket
            refreshStats();
        }
        
        function refreshStats() {
            console.log("Solicitando estat√≠sticas do servidor...");
            showLoading(true);

            // AQUI: L√≥gica para solicitar dados via WebSocket
            // Exemplo:
            // sendWebSocketMessage('get_stats', { 
            //     range: document.getElementById('timeRangeFilter').value 
            // });

            // Para fins de demonstra√ß√£o, usaremos dados falsos
            // Remova esta parte quando a integra√ß√£o WebSocket estiver pronta
            setTimeout(() => {
                const fakeData = generateFakeStats();
                updateAllStats(fakeData);
                showLoading(false);
            }, 1000);
        }

        // Fun√ß√£o para ser chamada quando os dados chegam via WebSocket
        function handleStatsUpdate(data) {
            console.log("Estat√≠sticas recebidas:", data);
            updateAllStats(data);
            showLoading(false);
        }

        function updateAllStats(data) {
            updateKPIs(data.kpis);
            updateConsumptionChart(data.consumption);
            updateUsersChart(data.users);
            updateHourlyChart(data.hourly);
            updateTopUsersTable(data.topUsers);
        }

        function updateKPIs(kpis) {
            document.getElementById('kpiTotalServed').textContent = kpis.totalServed || 0;
            document.getElementById('kpiDailyAverage').textContent = kpis.dailyAverage || '0.0';
            document.getElementById('kpiPeakDay').textContent = kpis.peakDay || 'N/A';
            document.getElementById('kpiTopUser').textContent = kpis.topUser || 'N/A';
        }

        function initCharts() {
            // Gr√°fico de Consumo
            const ctxConsumption = document.getElementById('consumptionChart').getContext('2d');
            consumptionChart = new Chart(ctxConsumption, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Caf√©s Servidos', data: [], borderColor: 'var(--primary-light)', tension: 0.1 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Gr√°fico de Usu√°rios
            const ctxUsers = document.getElementById('usersChart').getContext('2d');
            usersChart = new Chart(ctxUsers, {
                type: 'doughnut',
                data: {
                    labels: ['Ativos', 'Inativos', 'Sem Cr√©ditos'],
                    datasets: [{
                        data: [],
                        backgroundColor: ['var(--success-color)', 'var(--text-secondary)', 'var(--warning-color)'],
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Gr√°fico de Hor√°rios
            const ctxHourly = document.getElementById('hourlyChart').getContext('2d');
            hourlyChart = new Chart(ctxHourly, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'M√©dia de Caf√©s', data: [], backgroundColor: 'rgba(52, 152, 219, 0.6)' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }
        
        function updateConsumptionChart(data) {
            consumptionChart.data.labels = data.labels;
            consumptionChart.data.datasets[0].data = data.values;
            consumptionChart.update();
        }

        function updateUsersChart(data) {
            usersChart.data.datasets[0].data = data.values;
            usersChart.update();
        }
        
        function updateHourlyChart(data) {
            hourlyChart.data.labels = data.labels;
            hourlyChart.data.datasets[0].data = data.values;
            hourlyChart.update();
        }
        
        function updateTopUsersTable(users) {
            const tbody = document.getElementById('topUsersTableBody');
            if (users && users.length > 0) {
                tbody.innerHTML = users.map((user, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${escapeHtml(user.name)}</strong></td>
                        <td><code>${escapeHtml(user.uid)}</code></td>
                        <td><span class="badge badge-success">${user.count}</span></td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum dado de consumo dispon√≠vel.</td></tr>';
            }
        }
        
        // --- FUN√á√ÉO DE DADOS FALSOS (REMOVER EM PRODU√á√ÉO) ---
        function generateFakeStats() {
            return {
                kpis: {
                    totalServed: 1243,
                    dailyAverage: '12.8',
                    peakDay: 'Sexta-feira',
                    topUser: 'Jo√£o Silva'
                },
                consumption: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'],
                    values: [15, 22, 18, 25, 30, 12, 8]
                },
                users: {
                    values: [35, 5, 10] // Ativos, Inativos, Sem Cr√©ditos
                },
                hourly: {
                    labels: ['08h', '09h', '10h', '11h', '14h', '15h', '16h'],
                    values: [5, 8, 12, 7, 15, 11, 9]
                },
                topUsers: [
                    { name: 'Jo√£o Silva', uid: 'A1 B2 C3 D4', count: 128 },
                    { name: 'Maria Oliveira', uid: 'E5 F6 G7 H8', count: 97 },
                    { name: 'Carlos Pereira', uid: 'I9 J0 K1 L2', count: 85 },
                    { name: 'Ana Costa', uid: 'M3 N4 O5 P6', count: 72 },
                    { name: 'Lucas Souza', uid: 'Q7 R8 S9 T0', count: 61 }
                ]
            };
        }
    </script>
</body>
</html>